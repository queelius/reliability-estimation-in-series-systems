---
title: "Shape and scale of Weibull distribution"
author: "Alex Towell"
output:
    pdf_document:
        toc: yes
        toc_depth: 1
        number_sections: true
        extra_dependencies: ["graphicx","amsthm","amsmath","natbib","tikz"]
        df_print: kable
indent: true
---

\newcommand{\T}{T}
\newtheorem{definition}{Definition}
\newtheorem{theorem}{Theorem}
\newtheorem{corollary}{Corollary}
\newtheorem{condition}{Condition}
\renewcommand{\v}[1]{\boldsymbol{#1}}
\numberwithin{equation}{section}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(md.tools)
library(algebraic.mle)
library(dplyr)
library(ggplot2)
library(gridExtra)
library(grid)
library(glue)
library(png)
```

Shape and scale of the Weibull distribution
============


```{r echo=F, message=F, warning=F}
shape1 <- 3
scale1 <- 30
shape2 <- 1
scale2 <- 50
shape3 <- 2.5
scale3 <- 15
shape4 <- 5
scale4 <- 20
shape5 <- 0.25
scale5 <- 50

funs <- c(
  paste0("(", shape1, ",", scale1, ")"),
  paste0("(", shape2, ",", scale2, ")"),
  paste0("(", shape3, ",", scale3, ")"),
  paste0("(", shape4, ",", scale4, ")"),
  paste0("(", shape5, ",", scale5, ")"))

ts <- seq(0,100,by=.1)
h.wei1 <- Vectorize(function(t) (shape1/scale1)*(t/scale1)^(shape1-1))
h.wei2 <- Vectorize(function(t) (shape2/scale2)*(t/scale2)^(shape2-1))
h.wei3 <- Vectorize(function(t) (shape3/scale3)*(t/scale3)^(shape3-1))
h.wei4 <- Vectorize(function(t) (shape4/scale4)*(t/scale4)^(shape4-1))
h.wei5 <- Vectorize(function(t) (shape5/scale5)*(t/scale5)^(shape5-1))

df.haz <- data.frame(
    t=ts,
    y=c(h.wei1(ts),h.wei2(ts),h.wei3(ts),h.wei4(ts),h.wei5(ts)),
    fun=rep(funs, each=length(ts)))

R.wei1 <- Vectorize(function(t) exp(-(t/scale1)^shape1))
f.wei1 <- Vectorize(function(t) shape1/scale1*(t/scale1)^(shape1-1)*
    exp(-(t/scale1)^shape1))
R.wei2 <- Vectorize(function(t) exp(-(t/scale2)^shape2))
f.wei2 <- Vectorize(function(t) shape2/scale2*(t/scale2)^(shape2-1)*
    exp(-(t/scale2)^shape2))
R.wei3 <- Vectorize(function(t) exp(-(t/scale3)^shape3))
f.wei3 <- Vectorize(function(t) shape3/scale3*(t/scale3)^(shape3-1)*
    exp(-(t/scale3)^shape3))
R.wei4 <- Vectorize(function(t) exp(-(t/scale4)^shape4))
f.wei4 <- Vectorize(function(t) shape4/scale4*(t/scale4)^(shape4-1)*
    exp(-(t/scale4)^shape4))
R.wei5 <- Vectorize(function(t) exp(-(t/scale5)^shape5))
f.wei5 <- Vectorize(function(t) shape5/scale5*(t/scale5)^(shape5-1)*
    exp(-(t/scale5)^shape5))
df.pdf <- data.frame(
    t=ts,
    y=c(f.wei1(ts),f.wei2(ts),f.wei3(ts),f.wei4(ts),f.wei5(ts)),
    fun=rep(funs, each=length(ts)))

```


```{r exp_weib_haz, fig.align="center", fig.cap="Component lifetime plots", warning = FALSE, echo = FALSE}
caption_text <- glue(
    "Plots of five different components with Weibull distributed lifetimes. Key observations:\n",
    "(1) Components with a shape < 1 have decreasing hazards, e.g., component 1.\n",
    "(2) Components with shapes > 1 have increasing hazards, e.g., components 3, 4, and 5.\n",
    "(3) Components with shape = 1 have constant hazards, e.g., component 2.\n")

p1 <- ggplot(df.haz, aes(x=t, y=y, color=fun)) +
    geom_line() +
    labs(y = "Hazard",
         x = "Weibull Component Lifetimes") +
    ylim(0,.75) +
    xlim(.1,27) +
    theme_bw() +
    theme(panel.grid = element_blank(),
          legend.position="none")


p2 <- ggplot(df.pdf,aes(x=t, y=y, color=fun)) +
    geom_line() +
    labs(y = "Density",
         x = "Weibull Component Lifetimes") +
    ylim(0,.12) +
    xlim(.1,30) +
    theme_bw() +
    theme(panel.grid = element_blank(),
          legend.position="none")

p3 <- ggplot(df.haz, aes(x=t, y=y, color=fun)) +
    geom_line() +
    theme_void() +  # remove all non-legend elements
    theme(legend.position="bottom") +
    labs(color = expression(paste("(", k, ",", lambda, ")")))

caption <- textGrob(caption_text, gp=gpar(fontsize=9))
grid.arrange(
  arrangeGrob(p1, p2, ncol = 2),
  p3,
  bottom = caption,
  nrow = 3,
  heights = c(10, 1, 1))
```

The shape parameter $k$ may be understood in the following way:

- If $k < 1$, then the hazard function decreases with respect to system lifetime,
which may occur if defective items fail early and are weeded out.
- If $k > 1$, then the hazard function is increases with respect
to time, which may occur as a result of an aging process.
- If $k = 1$, then the failure rate is constant, which means it is exponentially
distributed.

See Figure \ref{fig:exp_weib_haz} for plots of the hazard and pdf functions of five different
Weibull distributed components. We will use these plots to illustrate the
different shapes of the hazard and pdf functions. The first component has a
shape parameter $k=0.25$, which is less than 1, and so the hazard function
decreases with respect to time. The second component has a shape parameter
$k=1$, and so the hazard function is constant. The third, fourth, and fifth
components have shape parameters $k=2.5$, $k=3$, and $k=5$, respectively, and
so the hazard functions increase with respect to time.

The lifetime of the series system composed of $m$ Weibull components
has a reliability function given by
\begin{equation}
\label{eq:sys_weibull_reliability_function}
R(t;\v\theta) = \exp\biggl\{-\sum_{j=1}^{m}\biggl(\frac{t}{\lambda_j}\biggr)^{k_j}\biggr\}.
\end{equation}
\begin{proof}
By Theorem \ref{thm:sys_reliability_function},
$$
R(t;\v\theta) = \prod_{j=1}^{m} R_j(t;\lambda_j,k_j).
$$
Plugging in the Weibull component reliability functions obtains the result
\begin{align*}
R(t;\v\theta)
    &= \prod_{j=1}^{m} \exp\biggl\{-\biggl(\frac{t}{\lambda_j}\biggr)^{k_j}\biggr\}\\
    &= \exp\biggl\{-\sum_{j=1}^{m}\biggl(\frac{t}{\lambda_j}\biggr)^{k_j}\biggr\}.
\end{align*}
\end{proof}

The Weibull series system's hazard function is given by
\begin{equation}
\label{eq:sys_weibull_failure_rate_function}
h(t;\v\theta) =
    \sum_{j=1}^{m} \frac{k_j}{\lambda_j}\biggl(\frac{t}{\lambda_j}\biggr)^{k_j-1},
\end{equation}
whose proof follows from Theorem \ref{thm:sys_failure_rate}.

```{r series_haz_pdf, cache=T, fig.cap = "System lifetime plots", fig.align = "center", echo=F, warning=F,message=F}
source("./wei.series.md.c1.c2.c3/R/wei_series.R")

h.series.ts <- hazard_wei_series(ts,
    scales=c(scale1,scale2,scale3,scale4,scale5),shapes=c(shape1,shape2,shape3,shape4,shape5))
df.series.haz <- data.frame(t=ts, y=h.series.ts)
p1 <- ggplot(df.series.haz,aes(x=t, y=y)) +
    geom_line() +
    ylim(0,.3) +
    xlim(0.02,15) +
    theme_bw() +
    labs(y = "Hazard",
         x = "Series System Lifetime") +
    theme(panel.grid = element_blank())

f.series.ts <- dwei_series(ts,
    scales=c(scale1,scale2,scale3,scale4,scale5),shapes=c(shape1,shape2,shape3,shape4,shape5))

df.series.f <- data.frame(t=ts, y=f.series.ts)
p2 <- ggplot(df.series.f,aes(x=t, y=y)) +
    geom_line() +
    labs(y = "Density",
         x = "Series System Lifetime") +
    ylim(0,.3) +
    xlim(.1,20) +
    theme_bw() +
    theme(panel.grid = element_blank())

caption_text <- glue(
    "Plots of the hazard function and the pdf of a series system with the previously discussed Weibull\n",
    "components. Key observations:\n",
    "(1) The hazard is initially large but decreases to some minimum before increasing again,\n",
    "exhibiting both a high infant mortality rate and an aging process. This is a pattern we\n",
    "see in nature (e.g., humans).\n",
    "(2) The pdf has a rather unusual form, a result of being a combination of Weibull distributions.")
caption <- textGrob(caption_text, gp=gpar(fontsize=9))
grid.arrange(
  arrangeGrob(p1, p2, ncol = 2),
  bottom = caption,
  nrow = 2,
  heights = c(10, 1))
```


In Figure \ref{fig:series_haz_pdf}, we plot the hazard function and the pdf of the
Weibull series system with the component lifetime parameters considered earlier,
\begin{align*}
T_{i 1} &\sim \operatorname{WEI}(3,30)\\
T_{i 2} &\sim \operatorname{WEI}(2,50)\\
T_{i 3} &\sim \operatorname{WEI}(0.5,15)\\
T_{i 4} &\sim \operatorname{WEI}(5,20)\\
T_{i 5} &\sim \operatorname{WEI}(0.25,50)\\
\end{align*}
for the $i$-th series system where $i=1,\ldots,n$. By Theorem \ref{thm:sys_lifetime},
the series system has a random lifetime given
by
$$
T_i = \operatorname{min}\{T_{i 1},\ldots,T_{i 5}\}.
$$
where $\v\theta = (k_1,\lambda_1,\ldots,k_5,\lambda_5)$.

The series system, due to being a mixture of Weibull components with different
shapes, has both a high infant mortality rate and an aging process,
which is reflected in the plot of the hazard function. The hazard is
initially high then decreases to some minimum before increasing again. This
is a pattern we see in nature, e.g., electronic appliances may fail early due to
defects, but those that survive the initial period of high failure rate
can be expected to last for a long time before finally wearing out due to an aging
process.

The pdf of the series system also appears to be multimodal, where the modes
correspond to the high infant mortality rate and the aging process.

The pdf of the series system is given by
\begin{equation}
\label{eq:sys_weibull_pdf}
f(t;\v\theta) =
\biggl\{
    \sum_{j=1}^m \frac{k_j}{\lambda_j}\left(\frac{t}{\lambda_j}\right)^{k_j-1}
\biggr\}
\exp
\biggl\{
    -\sum_{j=1}^m \bigl(\frac{t}{\lambda_j}\bigr)^{k_j}
\biggr\}.
\end{equation}
\begin{proof}
By definition,
$$
f(t;\v\theta) = h(t;\v\theta) R(t;\v\theta).
$$
Plugging in the failure rate and reliability functions given respectively by
Equations \eqref{eq:sys_weibull_reliability_function} and
\eqref{eq:sys_weibull_failure_rate_function} completes the proof.
\end{proof}




## Conditional probability of the component cause of failure given a system failure
The conditional pmf of $K_i$ given $\T_i$ is given by
\begin{equation}
\label{eq:weibull_pmf_k_given_s}
f(k;\v\theta|t) = \frac{\frac{k_k}{\lambda_k}\bigl(\frac{t}{\lambda_k}\bigr)^{k_k-1}}
    {\sum_{j=1}^m \frac{k_j}{\lambda_j}\bigl(\frac{t}{\lambda_j}\bigr)^{k_j-1}}.
\end{equation}
\begin{proof}
By Theorem \ref{thm:f_given_s_form_2},
$$
f(k;\v\theta|t) = \frac{h_k(t;\v{\theta_k})}{\sum_{j=1}^m h_j(t;\v{\theta_j})}
$$
where $h_1,\ldots,h_m$ are the failure rate functions of the $m$ Weibull
component lifetimes.
\end{proof}

The joint pdf of $K_i$ and $\T_i$ is given by
\begin{equation}
\label{eq:weibull_joint_k_s}
f(k,t;\v\theta) = \frac{k_k}{\lambda_j}\biggl(\frac{t}{\lambda_k}\biggr)^{k_k-1}
\exp\biggl\{-\sum_{j=1}^{m}\biggl(\frac{t}{\lambda_j}\biggr)^{k_j}\biggr\}.
\end{equation}
\begin{proof}
Plugging in the conditional probability and the marginal probability given
respectively by Equations \eqref{eq:expo_prob_K_given_S} and
\eqref{eq:expo_sys_pdf} completes the proof.

By Theorem \ref{thm:f_k_and_t}, the joint pdf of $K_i$ and $\T_i$ is given by
$$
f(k,t;\v\theta) = h_k(t;\v{\theta_k}) R_{\T_i}(t;\v\theta)
$$
where $R_{T_i}(t;\v\theta)$ is given by Equation
\eqref{eq:sys_weibull_reliability_function} and $h_k$ is the failure rate
function of the $k$\textsuperscript{th} Weibull component.
\end{proof}











```{r series_haz_pdf, cache=T, fig.cap = "Series System Hazard Function", fig.align = "center", echo=F, warning=F,message=F, fig.height=3, fig.width=5}
source("./wei.series.md.c1.c2.c3/R/wei_series.R")
shape1 <- .5
scale1 <- 10

mttf1 <- gamma(1 + 1/shape1) * scale1
shape2 <- 3.5
scale2 = mttf1 / gamma(1 + 1/shape2)

ts <- seq(1,20,by=.1)
h.series.ts <- hazard_wei_series(ts, scales=c(scale1, scale2), shapes=c(shape1, shape2))
df.series.haz <- data.frame(t=ts, y=h.series.ts)
p1 <- ggplot(df.series.haz,aes(x=t, y=y)) +
    geom_line() +
    theme_bw() +
    theme(axis.text.x = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks = element_blank()) +
    labs(y = "Hazard",
         x = "Series System Lifetime") +
    theme(panel.grid = element_blank())

f.series.ts <- dwei_series(ts,
    scales=c(scale1,scale2),shapes=c(shape1,shape2))

caption_text <- paste0(
    "Hazard function of a series system with a component that has a shape less than 1\n",
    "and a component with a shape greater than 1. In such cases, The hazard function is\n",
    "initially decreasing but eventually, exhibiting both infant mortality and aging phases.")

ggplot(df.series.haz,aes(x=t, y=y)) +
    geom_line() +
    theme_bw() +
    theme(axis.text.x = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks = element_blank()) +
    labs(y = "Hazard Function",
         x = "Series System Lifetime") +
    theme(panel.grid = element_blank()) +
    ggtitle(caption_text)
```


In Figure \ref{fig:series_haz_pdf}, we plot the hazard function and the pdf of the
Weibull series system with the component lifetime parameters given by
\begin{equation}
\begin{aligned}
    k_1 &= `r shape1` &\quad \lambda_2 &= `r scale1`\\
    k_2 &= `r shape2` &\quad \lambda_2 &= `r scale2`\\
\end{aligned}
\label{eq:weibull_params_1}
\end{equation}

The series system, due to being a mixture of Weibull components with different
shapes, has both a infant mortality and aging phases. The hazard is
initially decreasing but eventually increasing. This
is a pattern we see in nature, e.g., electronic appliances may fail early due to
defects, but those that survive the initial period of high failure rate
can be expected to last for a long time before finally wearing out due to an aging
process. The pdf of the series system also appears to be multi-modal due to the
different modes of the components.















\begin{proof}
The log-likelihood contribution for the i-th observation is given by Equation \eqref{eq:weibull_log_likelihood_contribution}:
$$
\ell_i = -\sum_{j=1}^m \biggl(\frac{t_i}{\lambda_j}\biggr)^{k_j} +
    \delta_i \log \Biggl(\sum_{j \in c_i} \frac{k_j}{\lambda_j} \biggl(\frac{t_i}{\lambda_j}\biggr)^{k_j - 1} \Biggr).
$$

\textbf{Shape parameters: $\partial \ell_i / \partial k_r$}

Proof steps here.

\textbf{Scale parameters: $\partial \ell_i / \partial \lambda_r$}
We want to find the derivative of $\ell_i$ with respect to $\lambda_r$. 
The derivative of the sum of functions is the sum of the derivatives, so we can
differentiate each term in the sum separately. 

First, we differentiate
$$
    -\sum_{j=1}^m (t_i/\lambda_j)^{k_j}
$$
with respect to $\lambda_r$. The derivative of this term with respect to
$\lambda_r$ is zero for all $j$ not equal to $r$, and for $j = r$, we have
$-(t_i/\lambda_r)^{k_r}$. The derivative of this term with respect to $\lambda_r$ is
$$
\frac{k_r}{\lambda_r} \biggl(\frac{t_i}{\lambda_r}\biggr)^{k_r}.
$$

Second, we differentiate
$$
\delta_i \log\Biggl(\sum_{j \in c_i} \frac{k_j}{\lambda_j} \biggl(\frac{t_i}{\lambda_j}\biggr)^{k_j - 1}\Biggr)
$$
with respect to $\lambda_r$.
The derivative of the logarithm of a function is the derivative of the function
divided by the function itself.
The function inside the logarithm is
$$
\sum_{j \in c_i} \frac{k_j}{\lambda_j} \left(\frac{t_i}{\lambda_j}\right)^{k_j - 1}. 
$$
The derivative of this function with respect to $\lambda_r$ is zero for all $j$ not
in $c_i$ or not equal to $r$, and for $j = r$ in $c_i$, we have
$$
\frac{k_r}{\lambda_r} \left(\frac{t_i}{\lambda_r}\right)^{k_r - 1}. 
$$
The derivative of this term with respect to $\lambda_r$ is
$$
\biggl(\frac{k_r}{\lambda_r}\biggr)^2 \biggl(\frac{t_i}{\lambda_r}\biggr)^{k_r - 1}.
$$
So, the derivative of the second term is
$$
\delta_i \frac{\bigl(\frac{k_r}{\lambda_r}\bigr)^2 \bigl(\frac{t_i}{\lambda_r}\bigr)^{k_r - 1} }
{\sum_{j \in c_i} \frac{k_j}{\lambda_j}\bigl(\frac{t_i}{\lambda_j}\bigr)^{k_j-1}}
$$
if $r$ in $c_i$ and zero otherwise.

Adding the derivatives of the first and second terms, we get the partial derivative
of $\ell_i$ with respect to $\lambda_r$,
$$
\frac{\partial \ell_i(\v\theta)}{\partial \lambda_r} = 
    \frac{k_r}{\lambda_r} \biggl(\frac{t_i}{\lambda_r}\biggr)^{k_r} -
    \delta_i \frac{
        \bigl(\frac{k_r}{\lambda_r}\bigr)^2 \bigl(\frac{t_i}{\lambda_r}\bigr)^{k_r - 1}
    }
    {
        \sum_{j \in c_i} \frac{k_j}{\lambda_j}\bigl(\frac{t_i}{\lambda_j}\bigr)^{k_j-1}
    },
$$
if $r \in c_i$ and zero otherwise.
This is the partial derivative of $\ell_i$ with respect to $\lambda_r$.
\end{proof}









## Appendix D: Probability of Component Failure {-}
Suppose we have jointly observed a candidate set and a series system
failure time and we are interested in the probability that a particular component
is the cause of the observed system failure.
\begin{theorem}
Assuming Conditions \ref{cond:c_contains_k} and \ref{cond:equal_prob_failure_cause},
the conditional probability of $K_i$ given $\mathcal{C}_i = c_i$ and $\T_i = t_i$
is given by
\begin{equation}
\label{eq:cond_prob_k_given_t_and_c}
\Pr\{K_i = j|\T_i=t_i,\mathcal{C}_i=c_i\} =
 \frac{h_j(t_i|\v{\theta_j})}{\sum_{l \in c_i} h_l(t_i|\v{\theta_l})} 1_{\{j \in c_i\}}.
\end{equation}
\end{theorem}
\begin{proof}
The conditional probability $\Pr\{K_i = j|\T_i=t_i,\mathcal{C}_i=c_i\}$ may be
written as
$$
\Pr\{K_i = j|\T_i=t_i,\mathcal{C}_i=c_i\} =
    \frac{\Pr{}_{\!\v\theta}\{\mathcal{C}_i=c_i|K_i = j,T_i=t_i\} f_{K_i,\T_i}(j,t_i;\v\theta)}
    {\sum_{j=1}^m \Pr{}_{\!\v\theta}
        \{\mathcal{C}_i=c_i|K_i = j,\T_i=t_i\} f_{K_i,\T_i}(j,t_i;\v\theta)}.
$$
By Theorem \ref{thm:f_k_and_t},
$f_{K_i,T_i}(j,t_i;\v\theta) = h_j(t_i;\v\theta)R_{\T_i}(t_i;\v\theta)$.
We may make this substitution in the above equation and cancel the common
factors $R_{\T_i}(t_i;\v\theta)$ in the numerator and denominator, yielding
$$
\Pr\{K_i = j|\T_i=t_i,\mathcal{C}_i=c_i\} =
    \frac{\Pr{}_{\!\v\theta}\{\mathcal{C}_i=c_i|K_i = j,T_i=t_i\} h_j(t_i;\v\theta)}
         {\sum_{j=1}^m \Pr{}_{\!\v\theta}\{\mathcal{C}_i=c_i|K_i=j,\T_i=t_i\} h_j(t_i;\v\theta)}.
$$
Assuming Condition \ref{cond:c_contains_k}, we may rewrite the above as
$$
\Pr\{K_i = j|\T_i=t_i,\mathcal{C}_i=c_i\}
    = \frac{\Pr{}_{\!\v\theta}\{\mathcal{C}_i=c_i|K_i = j,T_i=t_i\} h_j(t_i;\v\theta)}
        {\sum_{l \in c_i} \Pr{}_{\!\v\theta}\{\mathcal{C}_i=c_i|K_i = l,\T_i=t_i\} h_j(t_i;\v\theta)}.
$$
Assuming Condition \ref{cond:equal_prob_failure_cause}, we may rewrite the above
as
$$
\Pr\{K_i = j|T_i=t_i,\mathcal{C}_i=c_i\} =
    \frac{\Pr{}_{\!\v\theta}\{\mathcal{C}_i=c_i|K_i = j',T_i=t_i\} h_j(t_i;\v{\theta_j})}
    {\Pr{}_{\!\v\theta}\{\mathcal{C}_i=c_i|K_i = j',T_i=t_i\} {\sum_{l \in c_i} h_l(t_i;\v{\theta_l})}},
$$
where $j' \in c_i$.
Finally, we may cancel the common probability masking factors in the numerator
and denominator, obtaining the result
$$
\Pr\{K_i = j|T_i=t_i,\mathcal{C}_i=c_i\} =
    \frac{h_j(t_i;\v{\theta_j})}
    {\sum_{l \in c_i} h_l(t_i;\v{\theta_l})}.
$$
\end{proof}

Frequently, we may not have any information at all about the component cause of
failure, but we may still want to estimate the probability that a particular
component is the cause of a system failure at a particular time. In this case,
we may use the following corollary.
\begin{corollary}
The probability that the $j$\textsuperscript{th}
component is the cause of system failure given only that we know a system failure
occured at time $t_i$ is given by
$$
\Pr\{K_i = j|T_i=t_i\} = \frac{h_j(t_i;\v{\theta_j})}{\sum_{j=1}^m h_j(t_i;\v{\theta})}.
$$
\end{corollary}
\begin{proof}
If we cannot narrow the component cause of failure down to some subset of the
components, then we let $c_i$ contain all $m$ components, $c_i = \{1,\ldots,m\}$, and
plug that into Equation \ref{eq:cond_prob_k_given_t_and_c}. The result immediately
follows.
\end{proof}

